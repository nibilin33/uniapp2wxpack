"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("del"),t=require("gulp"),a=require("path"),n=require("single-line-log"),r=require("gulp-load-plugins"),s=require("vue-template-compiler"),i=require("preprocess"),p=require("shorthash2"),o=require("acorn-globals"),c=require("escodegen"),l=require("getmac"),u=require("fs-extra"),f=require("chokidar"),g=require("strip-json-comments"),d=require("vinyl"),h=require("gulp-strip-comments");function m(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var b=m(e),P=m(t),y=m(a),v=m(n),w=m(r),j=m(s),k=m(i),x=m(p),$=m(o),S=m(c),_=m(l),O=m(u),E=m(f),M=m(g),T=m(d),C=m(h),A="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};A.projectToSubPackageConfig=JSON.parse(process.env.TEST);const R={};R.scope=process.cwd(),R.type=process.env.UNI_UTS_PLATFORM||"weixin";const N={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:",projectConfig:"project.config.json",pluginConfig:"plugin.json",webpackGlobal:"global"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-",projectConfig:"project.swan.json",webpackGlobal:"global"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:",projectConfig:"project.config.json",webpackGlobal:"global"},alipay:{html:"axml",css:"acss",globalObject:"my",mainMpPath:"mainAlipayMpPath",directivePrefix:"a:",projectConfig:"mini.project.json",pluginConfig:"plugin.json",webpackGlobal:"my"}},L=N[R.type];if(!L)throw Error("小程序类型错");process.env.PACK_TYPE=R.type;const q=R.scope,B=A.projectToSubPackageConfig||{},F=B.sourceCodePath||"src",J=B.wxResourcePath||`${F}/${L.globalObject}resource`,W=B.wxResourceAlias||"@wxResource",I=RegExp(W+"\\/","g"),U=B.uniRequireApiName||"__uniRequireWx",D=RegExp(U+"\\(([a-zA-Z.\\/\"'@\\d-_]+)\\)","g"),K=B.uniImportWxssApiName||"__uniWxss",H=RegExp(`(}|^|\\s|;)${K}\\s*{([^{}]+)}`,"g"),Y=B.projectConfigPath||"",G=B.pluginTypeMiniProgramRoot||"miniprogram";let V="dev";"production"===process.env.NODE_ENV&&(V="build");const z="dist/"+V+"/mp-"+R.type;let Z="dist/"+V+`/mp-${R.type}-pack`;R.plugin&&(Z="dist/"+V+`/mp-${R.type}-pack-plugin`);var Q={pluginProcessFileTypes:B.pluginProcessFileTypes||["js","json","wxml","ttml","ttss","swan","css","html","wxss","htm","wxs","sjs","acss","axml"],currentNamespace:L,program:R,cwd:q,projectToSubPackageConfig:B,wxResourcePath:J,wxResourceAlias:W,regExpWxResources:I,uniRequireApiName:U,regExpUniRequire:D,uniImportWxssApiName:K,regExpUniImportWxss:H,configWxResourceKey:B.configWxResourceKey||"wxResource",env:V,base:z,target:Z,basePath:y.default.resolve(q,z),subModePath:y.default.resolve(q,Z,B.subPackagePath),targetPath:y.default.resolve(q,Z),packIsSubpackage:{mode:!1},mpTypeNamespace:N,sourceCodePath:F,projectConfigPath:Y,pluginTypeMiniProgramRoot:G};let X;const ee=v.default.stdout;var te={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){ee(e),clearTimeout(X),X=setTimeout(()=>{ee("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,a,n,r){a&&(a(t,n,r),t.childNodes?t.childNodes.forEach((t,n,r)=>{e(t,a,n,r)}):t.children&&t.children.forEach((t,n,r)=>{e(t,a,n,r)}))}};const{basePath:ae}=Q,{tryAgain:ne}=te;console.log("run gulp task"),P.default.task("clean:base",(async function e(t){try{await b.default([ae+"/**/*"],{force:!0})}catch(a){return void await ne(async()=>{await e(t)})}t()}));const{subModePath:re}=Q,{tryAgain:se}=te;P.default.task("clean:subModePath",(async function e(t){try{await b.default([re+"/**/*"],{force:!0})}catch(a){return void await se(async()=>{await e(t)})}t()}));const{targetPath:ie}=Q,{tryAgain:pe}=te;P.default.task("clean:previewDist",(async function e(t){try{await b.default([ie+"/**/*"],{force:!0})}catch(a){return void await pe(async()=>{await e(t)})}t()}));const{compile:oe}=j.default;var ce=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=oe(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,a){if(!e.attrsMap)return"";e.attrsMap[t]=a}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:a,attrsMap:n,children:r=[]}=t;return e+=this.writeOpenTag(a,n),e+=this.render(r),e+=this.writeCloseTag(a)},t)}writeOpenTag(e,t){if(t){const a=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${a.length>0?" "+a.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:le,mpTypeNamespace:ue}=Q,{deepFind:fe}=te,ge=Object.keys(ue).map(e=>ue[e].directivePrefix),de=Object.keys(ue).map(e=>ue[e].html),he=RegExp(`^(${ge.join("|")})`),me=RegExp(`\\.(${de.join("|")})$`,"i");var be=function(e,t){if(t.relative.match(me)){const t=new ce(e);return fe(t.topNode,e=>{if(!e.tag||3===e.type)return;const a=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&a&&!a.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",a+" ");const n=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&n&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",n);const r=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&r&&t.setAttr(e,"src",r.replace(me,"."+le.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(he)){const a=t.replace(he,le.directivePrefix);e.attrsMap[a]=e.attrsMap[t],a!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:Pe,mpTypeNamespace:ye}=Q,ve=Object.keys(ye).map(e=>ye[e].css),we=RegExp(`\\.(${ve.join("|")})$`,"i");var je=function(e,{relative:t}){return t.match(we)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(we,"."+Pe.css)}'`}))),e};var ke=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app\.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:xe}=k.default;var $e=function(e,{relative:t}){if(t.match(/\.js$/i))try{return xe(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:Se}=Q,{preprocess:_e}=k.default;var Oe=function(e,{relative:t}){if(t.match(RegExp(`.${Se.css}$`,"i")))try{return _e(e,process.env,{type:"css"})}catch(t){return console.log(Se.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:Ee}=Q,{preprocess:Me}=k.default;var Te=function(e,{relative:t}){if(t.match(RegExp(`.${Ee.html}$`,"i")))try{return Me(e,process.env,{type:"html"})}catch(t){return console.log(Ee.html+"条件编译出错"),console.log(t),e}return e};const{mpTypeNamespace:Ce,currentNamespace:Ae}=Q,Re=(process,new Set(Object.keys(Ce).map(e=>Ce[e].globalObject)));var Ne={mixinsEnvCode:function(e){let t="";return Re.forEach(e=>{Ae.globalObject!==e&&(t+=`var ${e} = ${Ae.globalObject};\n`)}),t}};const{mixinsEnvCode:Le}=Ne;var qe=function(e,{relative:t}){return t.match(/\.js$/i)?Le()+e:e};const{projectToSubPackageConfig:{subPackagePath:Be},basePath:Fe,currentNamespace:{webpackGlobal:Je}}=Q;const We={library:`webpackJsonp_${Be}_${x.default(Be+(0,_.default)()+Math.random()+Date.now())}`,reference:"webpackJsonp"};var Ie={htmlMixinPlugin:be,cssMixinPlugin:je,polyfillPlugin:ke,jsPreProcessPlugin:$e,cssPreProcessPlugin:Oe,htmlPreProcessPlugin:Te,jsMixinPlugin:qe,setLibrary:function(e,{fromAbsolute:t},a,n={}){n={...We,...n};let r=!1;if(t.startsWith(Fe)&&".js"===y.default.extname(t)){const t=$.default.parse(e),a=$.default(t);for(const{name:e,nodes:t}of a)if(e===Je)for(const{parents:e}of t)for(const t of e){const{type:e,property:{type:a,value:s}={}}=t;"MemberExpression"===e&&"Literal"===a&&s===n.reference&&(t.property.value=n.library,r=!0)}if(r){const e="production"===process.env.NODE_ENV?S.default.FORMAT_MINIFY:S.default.FORMAT_DEFAULTS;return S.default.generate(t,{format:e})}}return e}};const{projectToSubPackageConfig:Ue,targetPath:De}=Q,Ke=y.default;(!Ue.plugins||!Ue.plugins instanceof Array)&&(Ue.plugins=[]);var He={runPlugins:function(e){return function(t){const{plugins:a}=Ue;if(a&&!(!a instanceof Array))return a.reduce((t,a)=>{if("string"==typeof a&&(a=Ie[a]),"function"!=typeof a)return t;const n=Ke.resolve(e,this.file.relative),r={relative:n.replace(RegExp("^"+De.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:n,fromAbsolute:this.file.path,fromRelative:this.file.relative};this.removeAfterAdd=function(e){!function(e){O.default.existsSync(e)&&O.default.removeSync(e);const t=E.default.watch(e);t.on("add",(function(){O.default.removeSync(e),t.close()}))}(e=e||n)};const s=a.call(this,t,r,Ie);return null==s?t:s},t)}}};const Ye=w.default(),{cwd:Ge,projectToSubPackageConfig:{subPackagePath:Ve},target:ze,env:Ze,pluginProcessFileTypes:Qe,sourceCodePath:Xe,currentNamespace:{pluginConfig:et}}=Q,{writeLastLine:tt}=te,{runPlugins:at}=He;P.default.task("watch:pluginJson",(function(){const e=Ye.filter(Qe.map(e=>"**/*."+e),{restore:!0}),t=`${Xe}/${et}`;return P.default.src(t,{allowEmpty:!0,cwd:Ge}).pipe(Ye.if("dev"===Ze,Ye.watch(t,{cwd:Ge},(function(e){tt("处理"+e.relative+"......")})))).pipe(e).pipe(Ye.replace(/[\s\S]*/,at(y.default.resolve(Ge,ze+"/"+Ve)),{skipBinary:!1})).pipe(e.restore).pipe(P.default.dest(ze+"/"+Ve,{cwd:Ge}))}));const nt=w.default(),{cwd:rt,target:st,env:it,targetPath:pt,pluginProcessFileTypes:ot,currentNamespace:ct,projectConfigPath:lt}=Q,{writeLastLine:ut}=te,{runPlugins:ft}=He;P.default.task("watch:projectConfigJson",(function(){const e=nt.filter(ot.map(e=>"**/*."+e),{restore:!0});return P.default.src(`${lt?lt+"/":""}${ct.projectConfig}`,{allowEmpty:!0,cwd:rt}).pipe(nt.if("dev"===it,nt.watch(`${lt?lt+"/":""}${ct.projectConfig}`,{cwd:rt},(function(e){ut("处理"+e.relative+"......")})))).pipe(e).pipe(nt.replace(/[\s\S]*/,ft(pt),{skipBinary:!1})).pipe(e.restore).pipe(P.default.dest(st,{cwd:rt}))}));const{runPlugins:gt}=He,{program:dt,cwd:ht,projectToSubPackageConfig:mt,subModePath:bt,targetPath:Pt,packIsSubpackage:yt,currentNamespace:vt,target:wt,pluginTypeMiniProgramRoot:jt}=Q;var kt=function(){if(dt.plugin)return;const e=y.default.resolve(ht,mt[vt.mainMpPath]+"/app.js");if(O.default.existsSync(e)){const t=O.default.readFileSync(e,"utf8");let a=`./${mt.subPackagePath}/`,n="app.js";bt===Pt&&(n="uni-bootstrap.js");let r=`require('${a}${n}');\n`;(yt.mode||dt.plugin)&&(r="");const s=new T.default({cwd:ht,base:y.default.resolve(ht,mt[vt.mainMpPath]),path:e});O.default.outputFileSync(Pt+"/"+s.relative,gt(y.default.resolve(ht,wt+(dt.plugin?"/"+jt:""))).call({file:s},r+t))}};const xt=w.default(),{program:$t,cwd:St,projectToSubPackageConfig:_t,configWxResourceKey:Ot,base:Et,packIsSubpackage:Mt,currentNamespace:Tt,sourceCodePath:Ct}=Q,{writeLastLine:At}=te;var Rt=function(e){return At("处理app.json......"),xt.replace(/[\s\S]+/,(function(t){if($t.plugin&&"mainAppJson"===e)return t;Mt.mode=!1;let a,n,r,s={};({pagesJson(){try{a=JSON.parse(M.default(t))}catch(e){a={}}},baseAppJson(){try{n=JSON.parse(t)}catch(e){n={}}},mainAppJson(){try{r=JSON.parse(t)}catch(e){r={}}}})[e]();try{a||(a=JSON.parse(M.default(O.default.readFileSync(y.default.resolve(St,Ct+"/pages.json"),"utf8"))))}catch(e){a={}}try{n||(n=JSON.parse(O.default.readFileSync(y.default.resolve(St,Et+"/app.json"),"utf8")))}catch(e){n={}}try{r||(r=JSON.parse(O.default.readFileSync(y.default.resolve(St,_t[Tt.mainMpPath]+"/app.json"),"utf8")))}catch(e){r={}}function i(e){return _t.subPackagePath+(_t.subPackagePath?"/":"")+e}if(r.subpackages&&!r.subPackages&&(r.subPackages=r.subpackages),r.subPackages){let e=r.subPackages.find(e=>e.root===_t.subPackagePath);if(e){Mt.mode=!0;let t=[...a[Ot]&&a[Ot].pages||[],...n.pages||[]];return n.subPackages&&n.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),a[Ot]&&a[Ot].subPackages&&a[Ot].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,kt.call(this),delete n.pages,delete n.subPackages,JSON.stringify({...n,...r},null,2)}}n.pages&&n.pages.forEach((e,t)=>{n.pages[t]=i(e)}),n.subPackages&&n.subPackages.forEach(e=>{e.root=i(e.root)}),a[Ot]&&(a[Ot].pages&&a[Ot].pages.forEach((e,t)=>{a[Ot].pages[t]=i(e)}),a[Ot].subPackages&&a[Ot].subPackages.forEach(e=>{e.root=i(e.root)})),n.tabBar&&n.tabBar.list&&n.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:a,...r},s)=>{n.tabBar.list[s]={pagePath:e?i(e):"",iconPath:t?i(t):"",selectedIconPath:a?i(a):"",...r}}),s={...n,...r},s.pages=Array.from(new Set([...a.indexPage?[i(a.indexPage)]:[],...r.pages||[],...n.pages||[],...a[Ot]&&a[Ot].pages||[]]));let p=[],o={},c={};function l(e){e.forEach(e=>{o[e.root]=o[e.root]?Array.from(new Set([...o[e.root],...e.pages])):e.pages,e.name&&(c[e.root]=e.name)})}l(a[Ot]&&a[Ot].subPackages||[]),l(n.subPackages||[]),l(r.subPackages||[]);for(let e in o){const t={root:e,pages:o[e]};c[e]&&(t.name=c[e]),p.push(t)}if(s.subPackages=[...p],n.usingComponents){for(let e in n.usingComponents)n.usingComponents[e]="/"+_t.subPackagePath+n.usingComponents[e];s.usingComponents={...s.usingComponents||{},...n.usingComponents}}return kt.call(this),"toutiao"===$t.type&&s.subPackages&&(s.subPackages.forEach(e=>{e.pages.forEach(t=>{s.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete s.subPackages),JSON.stringify(s,null,2)}),{skipBinary:!1})};const Nt=w.default(),{cwd:Lt,target:qt,env:Bt,targetPath:Ft,pluginProcessFileTypes:Jt,sourceCodePath:Wt}=Q,{writeLastLine:It}=te,{runPlugins:Ut}=He;P.default.task("watch:pagesJson",(function(){const e=Nt.filter(Jt.map(e=>"**/*."+e),{restore:!0});return P.default.src(Wt+"/pages.json",{allowEmpty:!0,cwd:Lt}).pipe(Nt.if("dev"===Bt,Nt.watch(Wt+"/pages.json",{cwd:Lt},(function(e){It("处理"+e.relative+"......")})))).pipe(Rt("pagesJson")).pipe(Nt.rename("app.json")).pipe(e).pipe(Nt.replace(/[\s\S]*/,Ut(Ft),{skipBinary:!1})).pipe(e.restore).pipe(P.default.dest(qt,{cwd:Lt}))}));const Dt=w.default(),{cwd:Kt,target:Ht,env:Yt,base:Gt,targetPath:Vt,pluginProcessFileTypes:zt}=Q,{writeLastLine:Zt}=te,{runPlugins:Qt}=He;P.default.task("watch:baseAppJson",(function(){const e=Dt.filter(zt.map(e=>`${Gt}/**/*.${e}`),{restore:!0});return P.default.src(Gt+"/app.json",{allowEmpty:!0,cwd:Kt}).pipe(Dt.if("dev"===Yt,Dt.watch(Gt+"/app.json",{cwd:Kt},(function(e){Zt("处理"+e.relative+"......")})))).pipe(Rt("baseAppJson")).pipe(e).pipe(Dt.replace(/[\s\S]*/,Qt(Vt),{skipBinary:!1})).pipe(e.restore).pipe(P.default.dest(Ht,{cwd:Kt}))}));const Xt=w.default(),{cwd:ea,target:ta,env:aa,projectToSubPackageConfig:na,program:ra,currentNamespace:sa,pluginProcessFileTypes:ia,pluginTypeMiniProgramRoot:pa}=Q,{writeLastLine:oa}=te,{runPlugins:ca}=He;P.default.task("watch:mainAppJson",(function(){const e=na[sa.mainMpPath],t=Xt.filter(ia.map(t=>`${e}/**/*.${t}`),{restore:!0});return P.default.src(e+"/app.json",{allowEmpty:!0,cwd:ea}).pipe(Xt.if("dev"===aa,Xt.watch(e+"/app.json",{cwd:ea},(function(e){oa("处理"+e.relative+"......")})))).pipe(Rt("mainAppJson")).pipe(t).pipe(Xt.replace(/[\s\S]*/,ca(y.default.resolve(ea,ta+(ra.plugin?"/"+pa:""))),{skipBinary:!1})).pipe(t.restore).pipe(P.default.dest(ta+(ra.plugin?"/"+pa:""),{cwd:ea}))}));const la=w.default(),{cwd:ua,target:fa,env:ga,projectToSubPackageConfig:da,program:ha,basePath:ma,currentNamespace:ba,mpTypeNamespace:Pa,pluginProcessFileTypes:ya,pluginTypeMiniProgramRoot:va}=Q,{writeLastLine:wa}=te,{runPlugins:ja}=He;P.default.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=da[ba.mainMpPath];const t=Object.keys(Pa).map(t=>`${e}/app.${Pa[t].css}`),a=la.filter([...t],{restore:!0}),n=la.filter([e+"/app.js"],{restore:!0}),r=la.filter(ya.map(t=>`${e}/**/*.${t}`),{restore:!0});return P.default.src([e+"/app.js",...t],{allowEmpty:!0,cwd:ua}).pipe(la.if("dev"===ga,la.watch([e+"/app.js",`${e}/app.${ba.css}`],{cwd:ua},(function(e){wa("处理"+e.relative+"......")})))).pipe(n).pipe(la.replace(/^/,(function(e){return"require('./uni-bootstrap.js');\n"}),{skipBinary:!1})).pipe(n.restore).pipe(a).pipe(la.replace(/^/,(function(e){return O.default.readFileSync(`${ma}/app.${ba.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(la.rename((function(e){e.extname="."+ba.css}))).pipe(a.restore).pipe(r).pipe(la.replace(/[\s\S]*/,ja(y.default.resolve(ua,fa+(ha.plugin?"/"+va:""))),{skipBinary:!1})).pipe(r.restore).pipe(P.default.dest(fa+(ha.plugin?"/"+va:""),{cwd:ua}))}));const ka=w.default(),{cwd:xa,target:$a,env:Sa,projectToSubPackageConfig:_a,base:Oa,wxResourcePath:Ea,currentNamespace:Ma,mpTypeNamespace:Ta,pluginProcessFileTypes:Ca}=Q,{writeLastLine:Aa}=te,{runPlugins:Ra}=He;P.default.task("watch:mainWeixinMpPackPath",(function(){const e=_a[Ma.mainMpPath],t=e+"/"+_a.subPackagePath,a=$a+"/"+_a.subPackagePath,n=[],r=[],s=new Set,i=new Set;Object.keys(Ta).forEach(e=>{n.push(`${t}/**/*.${Ta[e].css}`),r.push(`${t}/**/*.${Ta[e].html}`),s.add("."+Ta[e].css),i.add("."+Ta[e].html)});const p=ka.filter([...r],{restore:!0}),o=ka.filter([...n],{restore:!0}),c=(ka.filter([t+"/**/*.js"],{restore:!0}),ka.filter(Ca.map(e=>`${t}/**/*.${e}`),{restore:!0}));return P.default.src([t,t+"/**/*","!"+t+"/pack.config.js"],{allowEmpty:!0,cwd:xa}).pipe(ka.if("dev"===Sa,ka.watch([t,t+"/**/*","!/"+t+"/pack.config.js"],{cwd:xa},(function(e){Aa("处理"+e.relative+"......")})))).pipe(ka.filter((function(t){if(t.relative!==Ma.projectConfig&&!function(e){const t=_a[Ma.mainMpPath]+"/"+_a.subPackagePath;return O.default.existsSync(e.path.replace(y.default.resolve(xa,t),y.default.resolve(xa,Oa)))?["ext.json",Ma.projectConfig].indexOf(e.relative)>-1&&_a.mergePack&&""===_a.subPackagePath:!O.default.existsSync(e.path.replace(y.default.resolve(xa,t),y.default.resolve(xa,Ea)))}(t))return!1;if("unlink"===t.event){try{let a=t.path;const n=RegExp(t.extname+"$","i");s.has(t.extname)&&(a=a.replace(n,"."+Ma.css)),i.has(t.extname)&&(a=a.replace(n,"."+Ma.html)),b.default.sync([a.replace(y.default.resolve(xa,e),y.default.resolve(xa,$a))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(ka.rename((function(e){e.extname="."+Ma.html}))).pipe(p.restore).pipe(o).pipe(ka.rename((function(e){e.extname="."+Ma.css}))).pipe(o.restore).pipe(c).pipe(ka.replace(/[\s\S]*/,Ra(y.default.resolve(xa,a)),{skipBinary:!1})).pipe(c.restore).pipe(P.default.dest(a,{cwd:xa}))}));const Na=w.default(),{cwd:La,target:qa,env:Ba,projectToSubPackageConfig:Fa,subModePath:Ja,targetPath:Wa,program:Ia,packIsSubpackage:Ua,currentNamespace:Da,mpTypeNamespace:Ka,pluginProcessFileTypes:Ha,pluginTypeMiniProgramRoot:Ya}=Q,{writeLastLine:Ga}=te,{runPlugins:Va}=He;P.default.task("watch:mainWeixinMp",(function(){const e=Fa[Da.mainMpPath],t=e+"/"+Fa.subPackagePath,a=[],n=[],r=new Set,s=new Set;Object.keys(Ka).forEach(t=>{a.push(`${e}/**/*.${Ka[t].css}`),n.push(`${e}/**/*.${Ka[t].html}`),r.add("."+Ka[t].css),s.add("."+Ka[t].html)});const i=Na.filter([e+"/app.js"],{restore:!0}),p=(Na.filter([e+"/**/*.js"],{restore:!0}),Na.filter([...n],{restore:!0})),o=Na.filter([...a],{restore:!0}),c=Na.filter(Ha.map(t=>`${e}/**/*.${t}`),{restore:!0});return P.default.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${Da.html}___jb_tmp___`,"!"+e+`/**/*.${Da.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+t+"/**/*"],{base:y.default.resolve(La,e),allowEmpty:!0,cwd:La}).pipe(Na.if("dev"===Ba,Na.watch([e+"/**/*","!/"+e+"/app.json","!/"+t+"/**/*"],{cwd:La},(function(e){e.relative.match(/.json/),Ga("处理"+e.relative+"......")})))).pipe(Na.filter((function(t){if("unlink"===t.event){try{let a=t.path;const n=RegExp(t.extname+"$","i");r.has(t.extname)&&(a=a.replace(n,"."+Da.css)),s.has(t.extname)&&(a=a.replace(n,"."+Da.html)),b.default.sync([a.replace(y.default.resolve(La,e),y.default.resolve(La,qa))],{force:!0})}catch(e){}return!1}return!0}))).pipe(i).pipe(Na.replace(/[\s\S]*/,(function(e){if(Ua.mode||Ia.plugin)return e;let t=`./${Fa.subPackagePath}/`,a="app.js";return Ja===Wa&&(a="uni-bootstrap.js"),e.match(RegExp(`require\\('${t.replace(/\./g,"\\.")}app.js'\\)`))?e:`require('${t}${a}');\n${e}`}),{skipBinary:!1})).pipe(i.restore).pipe(p).pipe(Na.rename((function(e){e.extname="."+Da.html}))).pipe(p.restore).pipe(o).pipe(Na.rename((function(e){e.extname="."+Da.css}))).pipe(o.restore).pipe(c).pipe(Na.replace(/[\s\S]*/,Va(y.default.resolve(La,qa+(Ia.plugin?"/"+Ya:""))),{skipBinary:!1})).pipe(c.restore).pipe(P.default.dest(qa+(Ia.plugin?"/"+Ya:""),{cwd:La}))}));var za={fakeUniBootstrap:function(e,t,a,n){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:n}),globalObject.onAppHide&&globalObject.onAppShow||(a="none",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation和top，所以转为none")),"relegation"!==a||globalObject.onAppRoute||(a="top",console.warn("uniapp2wxpack warn: ide不支持appMode设为relegation，但是支持top，所以转为top"));var r=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?r.__packInit[s]=e[s]:function(t){r.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==a){var i=Page,p=Component,o="",c=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute&&globalObject.onAppRoute((function(n){"top"!==a&&0!==("/"+n.path).indexOf(t+"/")&&(c=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),o=n.path})),globalObject.onAppHide((function(n){if("top"===a)return globalObject.getLaunchOptionsSync?e.onHide.call(e,globalObject.getLaunchOptionsSync()):e.onHide.call(e,n);var r=getCurrentPages();return 0===("/"+(null==r[r.length-1].route?r[r.length-1].__route__:r[r.length-1].route)).indexOf(t+"/")?(c=1,o="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(t){if(l&&(getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0),"top"===a&&"function"==typeof e.onShow)return globalObject.getLaunchOptionsSync?e.onShow.call(e,globalObject.getLaunchOptionsSync()):e.onShow.call(e,t)})),"top"===a&&l&&"function"==typeof e.onLaunch&&globalObject.getLaunchOptionsSync&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),i.call(this,e)},Component=function(e){return u(e.methods||{}),p.call(this,e)}}function u(n){if("top"!==a){var r=n.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(n.onShow=function(){var a=getCurrentPages(),n=null==a[a.length-1].route?a[a.length-1].__route__:a[a.length-1].route;if(o&&0===("/"+o).indexOf(t+"/")||0!==("/"+n).indexOf(t+"/")||(c&&(c=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof r)return r.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const{basePath:Za,targetPath:Qa,subModePath:Xa,currentNamespace:en}=Q;var tn=function(e){const t=y.default.resolve(Qa,"app.js"),a=y.default.resolve(Qa,"app."+en.css),n=e.path.replace(Za,Xa);return t===n||a===n};const an=w.default(),{regExpWxResources:nn,regExpUniRequire:rn}=Q,{getLevelPath:sn,getLevel:pn}=te;var on={uniRequireWxResource:function(){return an.replace(/[\s\S]*/,(function(e,t){const a=["var __uniPackNativeRequireInject={};\n"],n=pn(this.file.relative);return e=e.replace(rn,(e,t)=>{console.log(`\n编译${e}--\x3erequire(${t.replace(nn,sn(n))})`);const r=t.replace(nn,sn(n)),s=`__uniPackNativeRequireInject[${r}] = require(${r});\n`;return 0>a.indexOf(s)&&a.push(s),`__uniPackNativeRequireInject[${r}]`}),a[1]?`${a.join("")} ${e}`:e}),{skipBinary:!1})}};const{currentNamespace:cn,regExpWxResources:ln,wxResourceAlias:un}=Q,{getLevelPath:fn,getLevel:gn}=te;var dn=function(e,t){const a=gn(t);return"@import "+`"${un}/app.${cn.css}";`.replace(ln,fn(a))+("\n"+e)};const hn=w.default(),{fakeUniBootstrapName:mn,fakeUniBootstrap:bn}=za,{cwd:Pn,env:yn,program:vn,basePath:wn,targetPath:jn,subModePath:kn,base:xn,regExpUniRequire:$n,regExpWxResources:Sn,regExpUniImportWxss:_n,currentNamespace:On,mpTypeNamespace:En,pluginProcessFileTypes:Mn,sourceCodePath:Tn,projectToSubPackageConfig:Cn}=Q,An=process.env.PACK_TYPE,{writeLastLine:Rn,getLevel:Nn,getLevelPath:Ln,deepFind:qn}=te,{uniRequireWxResource:Bn}=on,{runPlugins:Fn}=He,Jn=Object.keys(En).map(e=>En[e].css),Wn=new Set(Jn);P.default.task("subMode:createUniSubPackage",(function(){O.default.mkdirsSync(wn);const e=hn.filter(xn+"/**/*.js",{restore:!0}),t=hn.filter([xn+"/common/vendor.js"],{restore:!0}),a=hn.filter([xn+"/common/main.js"],{restore:!0}),n=hn.filter(Mn.map(e=>`${xn}/**/*.${e}`),{restore:!0}),r=hn.filter([xn+"/**/*.js","!"+xn+"/app.js","!"+xn+"/uni-bootstrap.js","!"+xn+"/common/vendor.js","!"+xn+"/common/main.js","!"+xn+"/common/runtime.js"],{restore:!0}),s=hn.filter([`${xn}/**/*.${On.css}`,`!${xn}/app.${On.css}`,`!${xn}/common/main.${On.css}`],{restore:!0}),i=hn.filter([`${xn}/**/*.${On.css}`,`!${xn}/app.${On.css}`],{restore:!0}),p=hn.filter([xn+"/**/*.json"],{restore:!0}),o=hn.filter([`${xn}/**/*.${On.html}`],{restore:!0});return P.default.src([xn+"/**","!"+xn+"/app.json",xn+"/app.js",`${xn}/app.${On.css}`],{allowEmpty:!0,cwd:Pn}).pipe(hn.if("dev"===yn,hn.watch([xn+"/**/*","!/"+xn+"/app.json"],{cwd:Pn},(function(e){Rn("处理"+e.relative+"......")})))).pipe(hn.filter((function(e){if(function(e){if(0>["ext.json",On.projectConfig].indexOf(e.relative))return!1;if(Cn.mergePack&&""===Cn.subPackagePath){if(O.default.existsSync(y.default.resolve(Pn,Cn[On.mainMpPath],e.relative)))return!0}return!1}(e))return!1;if("unlink"===e.event){try{let t=e.path;const a=RegExp(e.extname+"$","i");Wn.has(e.extname.substr(1))&&(t=t.replace(a,"."+On.css)),b.default.sync([t.replace(wn,y.default.resolve(Pn,kn))],{force:!0})}catch(e){}return!1}return!tn(e)||".js"===e.extname&&(e.basename="uni-bootstrap.js",!0)}))).pipe(o).pipe(hn.replace(/[\s\S]*/,(function(e){const t=this.file.path.replace(RegExp(On.html+"$","i"),On.css),a=this.file.relative.replace(RegExp(On.html+"$","i"),On.css);O.default.existsSync(t)||O.default.outputFileSync(y.default.resolve(Pn,kn,a),dn("",a));const n=new ce(e);let r=0;return qn(n.topNode,e=>{if(1===e.type&&"wxs"===e.tag&&1===e.children.length&&3===e.children[0].type){e.children[0].text.replace($n,(t,a,n,s)=>{const i=Nn(this.file.relative),p=a.replace(Sn,Ln(i)).replace(/['"]/g,"");e.attrsMap.src=p,e.children=[],r=1,console.log(`\n编译${t}--\x3erequire(${p})`)})}}),r?n.render():e}),{skipBinary:!1})).pipe(o.restore).pipe(t).pipe(hn.replace(/^/,(function(e){return vn.plugin?`var App=function(packInit){};${On.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${mn}=${(""+bn).replace(/globalObject/g,On.globalObject)};${mn}(packInit,__packConfig.packPath,__packConfig.appMode,'${An}');};`}),{skipBinary:!1})).pipe(t.restore).pipe(e).pipe(C.default()).pipe(Bn()).pipe(e.restore).pipe(a).pipe(hn.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(hn.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(a.restore).pipe(r).pipe(hn.replace(/^/,(function(e){if(O.default.existsSync(y.default.resolve(Pn,Tn,this.file.relative)))return e;let t=Ln(Nn(this.file.relative)),a="app.js";return kn===jn&&(a="uni-bootstrap.js"),`require('${t}${a}');\n`}),{skipBinary:!1})).pipe(r.restore).pipe(p).pipe(hn.replace(/[\s\S]*/,(function(e){if(!O.default.existsSync(y.default.resolve(Pn,Tn,this.file.relative.replace(/json$/,"vue")))&&!O.default.existsSync(y.default.resolve(Pn,Tn,this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=Ln(Nn(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(p.restore).pipe(i).pipe(hn.stripCssComments()).pipe(hn.replace(_n,(function(e,t,a){let n="",r=Nn(this.file.relative);return(a+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const a=RegExp(`(${Jn.join("|")})(['"])$`);t=t.replace(a,On.css+"$2"),n+=`@import ${t.replace(Sn,Ln(r))};\n`})),t+n}),{skipBinary:!1})).pipe(i.restore).pipe(s).pipe(hn.stripCssComments()).pipe(hn.replace(/^[\s\S]*$/,(function(e){return kn===jn?e:dn(e,this.file.relative)}),{skipBinary:!1})).pipe(s.restore).pipe(n).pipe(hn.replace(/[\s\S]*/,Fn(kn),{skipBinary:!1})).pipe(n.restore).pipe(P.default.dest(kn,{cwd:Pn}))}));const In=w.default(),{cwd:Un,env:Dn,targetPath:Kn,subModePath:Hn,regExpWxResources:Yn,regExpUniImportWxss:Gn,wxResourcePath:Vn,currentNamespace:zn,mpTypeNamespace:Zn,pluginProcessFileTypes:Qn,projectToSubPackageConfig:Xn}=Q,{writeLastLine:er,getLevel:tr,getLevelPath:ar}=te,{uniRequireWxResource:nr}=on,{runPlugins:rr}=He,sr=[],ir=[],pr=[],or=new Set,cr=new Set;Object.keys(Zn).forEach(e=>{sr.push(Zn[e].css),ir.push(`${Vn}/**/*.${Zn[e].css}`),pr.push(`${Vn}/**/*.${Zn[e].html}`),or.add("."+Zn[e].css),cr.add("."+Zn[e].html)}),P.default.task("subMode:copyWxResource",(function(){const e=Xn[zn.mainMpPath],t=In.filter([Vn+"/**/*.js"],{restore:!0}),a=In.filter([...ir],{restore:!0}),n=In.filter([...pr],{restore:!0}),r=In.filter(Qn.map(e=>`${Vn}/**/*${e}`),{restore:!0});return P.default.src([Vn+"/**",Vn,`!${e}/app.json`],{allowEmpty:!0,cwd:Un}).pipe(In.if("dev"===Dn,In.watch([Vn+"/**",Vn,`!/${e}/app.json`,`!/${Vn}/**/*.*___jb_tmp___`],{cwd:Un},(function(e){er("处理"+e.relative+"......")})))).pipe(t).pipe(In.replace(/^/,(function(e){let t=ar(tr(this.file.relative)),a="app.js";return Hn===Kn&&(a="uni-bootstrap.js"),`require('${t}${a}');\n`}),{skipBinary:!1})).pipe(C.default()).pipe(nr()).pipe(t.restore).pipe(a).pipe(In.stripCssComments()).pipe(In.replace(Gn,(function(e,t,a){let n="";tr(this.file.relative);return t+n}),{skipBinary:!1})).pipe(In.replace(/^[\s\S]*$/,(function(e){return Hn===Kn?e:dn(e,this.file.relative)}),{skipBinary:!1})).pipe(In.rename((function(e){e.extname="."+zn.css}))).pipe(a.restore).pipe(n).pipe(In.rename((function(e){e.extname="."+zn.html}))).pipe(n.restore).pipe(In.filter((function(e){if("unlink"===e.event){try{let t=e.path;const a=RegExp(e.extname+"$","i");or.has(e.extname)&&(t=t.replace(a,"."+zn.css)),cr.has(e.extname)&&(t=t.replace(a,"."+zn.html)),b.default.sync([t.replace(y.default.resolve(Un,Vn),y.default.resolve(Un,Hn))],{force:!0})}catch(e){}return!1}return!0}))).pipe(r).pipe(In.replace(/[\s\S]*/,rr(Hn),{skipBinary:!1})).pipe(r.restore).pipe(P.default.dest(Hn,{cwd:Un}))}));const lr=w.default(),{cwd:ur,target:fr,env:gr,projectToSubPackageConfig:dr,currentNamespace:hr,mpTypeNamespace:mr,pluginProcessFileTypes:br}=Q,{writeLastLine:Pr}=te,{runPlugins:yr}=He;P.default.task("watch:native",(function(){const e=dr[hr.mainMpPath],t=[],a=[],n=new Set,r=new Set;Object.keys(mr).forEach(s=>{t.push(`${e}/**/*.${mr[s].css}`),a.push(`${e}/**/*.${mr[s].html}`),n.add("."+mr[s].css),r.add("."+mr[s].html)});lr.filter([e+"/**/*.js"],{restore:!0});const s=lr.filter([...a],{restore:!0}),i=lr.filter([...t],{restore:!0}),p=lr.filter(br.map(t=>`${e}/**/*.${t}`),{restore:!0});return P.default.src([e+"/**/*","!"+e+"/app.json"],{base:y.default.resolve(ur,e),allowEmpty:!0,cwd:ur}).pipe(lr.if("dev"===gr,lr.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:ur},(function(e){Pr("处理"+e.relative+"......")})))).pipe(lr.filter((function(t){if("unlink"===t.event){try{let a=t.path;const s=RegExp(t.extname+"$","i");n.has(t.extname)&&(a=a.replace(s,"."+hr.css)),r.has(t.extname)&&(a=a.replace(s,"."+hr.html)),b.default.sync([a.replace(y.default.resolve(ur,e),y.default.resolve(ur,fr))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(s).pipe(lr.rename((function(e){e.extname="."+hr.html}))).pipe(s.restore).pipe(i).pipe(lr.rename((function(e){e.extname="."+hr.css}))).pipe(i.restore).pipe(p).pipe(lr.replace(/[\s\S]*/,yr(y.default.resolve(ur,fr)),{skipBinary:!1})).pipe(p.restore).pipe(P.default.dest(fr,{cwd:ur}))}));const{cwd:vr,env:wr,targetPath:jr,subModePath:kr,projectToSubPackageConfig:xr,program:$r,currentNamespace:Sr}=Q,{tryAgain:_r}=te;async function Or(e){let t=y.default.resolve(vr,xr[Sr.mainMpPath],"app.js");await O.default.exists(t)||await O.default.outputFile(t,"App({});"),e()}P.default.task("mpWxSubMode",P.default.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if($r.plugin||$r.native)t();else{try{let e={packPath:(xr.subPackagePath?"/":"")+xr.subPackagePath,appMode:xr.appMode};await O.default.outputFile(kr+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(a){return void await _r(async()=>{await e(t)})}t()}}),function(){let e=[Or,"subMode:createUniSubPackage","subMode:copyWxResource",...$r.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...xr.mergePack?["watch:mainWeixinMpPackPath"]:[],...kr===jr?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return $r.native&&(e=[Or,"watch:mainAppJson","watch:native"]),"build"===wr?P.default.series.apply(this,e):P.default.parallel.apply(this,e)}(),(function(e){e(),"build"===wr&&process.exit()})));const{cwd:Er,basePath:Mr,base:Tr,program:Cr}=Q;P.default.task("startToPackServe",P.default.series((async function(e){Cr.native||await O.default.exists(Mr)||await O.default.mkdirs(Mr),e()}),"clean:base",(function(e){Cr.native?e():P.default.watch(Tr+"/app.json",{events:["all"],cwd:Er},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});exports.default={};
